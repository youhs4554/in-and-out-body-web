{% extends 'base.html' %}

{% block title %}Report{% endblock %}

{% block content %}
<h2>ê²€ì‚¬ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</h2>
<form id="dataForm" method="post">
    {% csrf_token %}
    <label for="group">ê·¸ë£¹ ì„ íƒ</label>
    <select name="group" id="group">
        <option value="">-- ê·¸ë£¹ ì„ íƒ --</option>
        {% for group in groups %}
            <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
        {% endfor %}
    </select>
    <button type="submit" class="button">ì¡°íšŒ</button>
</form>

<!-- Spinner Container: Initially Hidden -->
<div id="spinnerContainer" class="spinner-container" style="display: none;">
    <div class="spinner"></div>
    <p>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
</div>

<!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
{% if error_message %}
    <p style="color:red;">{{ error_message }}</p>
{% endif %}

{% if is_registered == False %}
    <p style="color:red;">ë“±ë¡ëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì •ë³´ ë“±ë¡ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš” ğŸ˜…</p>
{% endif %}

{% if user_results %}
    <h3>{{ selected_group }}ì˜ ë¶„ì„ í˜„í™©</h3>
    <div class="table-container">
        <p>ë°ì´í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</p>
    
        <!-- Display progress -->
        <div class="progress-container">
            <p>ì§„í–‰ë¥ : {{ progress_percentage|floatformat:1 }}%</p>
            <div class="progress-bar">
                <div class="progress" style="width: {{ progress_percentage|floatformat:1 }}%;"></div>
            </div>
        </div>
    
        <table>
            <thead>
                <tr>
                    {% if request.user.user_type == 'S' %}
                        <th>í•™ë…„</th>
                        <th>ë°˜</th>
                        <th>ë²ˆí˜¸</th>
                    {% else %}
                        <th>ë¶€ì„œëª…</th>
                    {% endif %}
                    <th>ì´ë¦„</th>
                    <th>ì²´í˜• ë¶„ì„ ê²°ê³¼</th>
                </tr>
            </thead>
            <tbody id="userResultsTableBody">
                {% for result in user_results %}
                <tr data-id="{{ result.user.id }}" data-valid="{{ result.analysis_valid }}">
                    {% if request.user.user_type == 'S' %}
                        <td>{{ result.user.student_grade }}</td>
                        <td>{{ result.user.student_class }}</td>
                        <td>{{ result.user.student_number }}</td>
                    {% else %}
                        <td>{{ result.user.department }}</td>
                    {% endif %}
                    <td>{{ result.user.student_name }}</td>
                    <td>
                        {% if result.analysis_valid %}
                            <a href="{% url 'report_detail' result.user.id %}" class="icon-button success" aria-label="View Report">
                                <i class="fa-solid fa-check"></i>
                            </a>
                        {% else %}
                            <a href="{% url 'no_result' %}" class="icon-button error" aria-label="No Result">
                                <i class="fa-solid fa-times"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination-container">
            <button class="pagination-button" id="prevPage">ì´ì „</button>
            <button class="pagination-button" id="nextPage">ë‹¤ìŒ</button>
        </div>
    </div>
{% endif %}

<!-- Include JavaScript for Pagination and Fetch -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const rowsPerPage = 10;
    let currentPage = 1;
    const userResultsTableBody = document.getElementById('userResultsTableBody');
    let rows = [];

    if (userResultsTableBody) {
        rows = Array.from(userResultsTableBody.querySelectorAll('tr'));
    }

    let totalPages = Math.ceil(rows.length / rowsPerPage);

    const prevButton = document.getElementById("prevPage");
    const nextButton = document.getElementById("nextPage");

    function updatePaginationButtons() {
        prevButton.style.display = currentPage > 1 ? '' : 'none';
        nextButton.style.display = currentPage < totalPages ? '' : 'none';
    }

    function displayTable(page) {
        const startIndex = (page - 1) * rowsPerPage;
        const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
        
        rows.forEach((row, index) => {
            row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
        });

        updatePaginationButtons();
    }

    prevButton.addEventListener("click", function() {
        if (currentPage > 1) {
            currentPage--;
            displayTable(currentPage);
        }
    });

    nextButton.addEventListener("click", function() {
        if (currentPage < totalPages) {
            currentPage++;
            displayTable(currentPage);
        }
    });

    // íë¡œ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ê´€ë¦¬
    function loadQueue(key) {
        const storedQueue = sessionStorage.getItem(key);
        return storedQueue ? JSON.parse(storedQueue) : [];
    }

    function saveQueue(key, queue) {
        sessionStorage.setItem(key, JSON.stringify(queue));
    }

    function enqueue(key, data, maxSize) {
        let queue = loadQueue(key);
        queue.push(data);
        if (queue.length > maxSize) {
            queue.shift();
        }
        saveQueue(key, queue);
    }

    function dequeue(key) {
        let queue = loadQueue(key);
        const data = queue.shift();
        saveQueue(key, queue);
        return data;
    }

    function peekQueue(key) {
        const queue = loadQueue(key);
        return queue.length > 0 ? queue[0] : null;
    }

    function clearQueue(key) {
        sessionStorage.removeItem(key);
    }

    // ìƒíƒœ ì €ì¥
    window.addEventListener("beforeunload", () => {
        const selectedGroup = document.querySelector("#group").value;
        const tableData = rows.map(row => row.outerHTML);
        
        enqueue("selectedGroupQueue", selectedGroup, 5);
        enqueue("tableDataQueue", JSON.stringify(tableData), 5);
        sessionStorage.setItem("currentPage", currentPage);
    });

    const savedGroup = dequeue("selectedGroupQueue");
    const savedTableData = dequeue("tableDataQueue");
    const savedPage = sessionStorage.getItem("currentPage");

    if (savedGroup) {
        document.querySelector("#group").value = savedGroup;
    }

    if (savedTableData) {
        userResultsTableBody.innerHTML = JSON.parse(savedTableData).join('');
    }

    rows.length = 0;
    Array.from(userResultsTableBody.querySelectorAll('tr')).forEach(row => rows.push(row));

    totalPages = Math.ceil(rows.length / rowsPerPage);

    if (savedPage) {
        currentPage = parseInt(savedPage);
        displayTable(currentPage);
    } else {
        displayTable(currentPage);
    }

    window.addEventListener("beforeunload", () => {
        clearQueue('selectedGroupQueue');
        clearQueue('tableDataQueue');
    });

    const form = document.getElementById("dataForm");
    const spinnerContainer = document.getElementById('spinnerContainer');

    form.addEventListener('submit', function(event) {
        event.preventDefault();  // ê¸°ë³¸ ì œì¶œ ë™ì‘ ë°©ì§€
        spinnerContainer.style.display = 'flex';  // ìŠ¤í”¼ë„ˆ í‘œì‹œ
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.text())
        .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                // í…Œì´ë¸” ì—…ë°ì´íŠ¸
                document.getElementById('userResultsTableBody').innerHTML = doc.getElementById('userResultsTableBody').innerHTML;

                // ìƒˆë¡œìš´ rows ë°°ì—´ì„ ì—…ë°ì´íŠ¸
                rows = Array.from(document.getElementById('userResultsTableBody').querySelectorAll('tr'));
                currentPage = 1;  // í˜ì´ì§€ ì´ˆê¸°í™”
                displayTable(currentPage);  // í…Œì´ë¸” ì¬í‘œì‹œ
                spinnerContainer.style.display = 'none';  // ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
            })
        .catch(error => {
            console.error('Error:', error);
            spinnerContainer.style.display = 'none';  // ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í”¼ë„ˆ ìˆ¨ê¹€
        });
    });

});

// ì„¸ì…˜ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
window.addEventListener("beforeunload", () => {
    sessionStorage.clear();
});

</script>
{% endblock %}
