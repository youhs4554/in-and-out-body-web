{% extends 'base.html' %}

{% block title %}Report{% endblock %}

{% block content %}
<h2>ê²€ì‚¬ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</h2>
<div class="form-div">
    <form id="dataForm" method="post">
        {% csrf_token %}
        {% if request.user.user_type == 'S' %}
        <div style="display: inline-block">       
                <label for="year">ì—°ë„ ì„ íƒ</label>
                <select name="year" id="year">
                    <option value="">-- ì—°ë„ ì„ íƒ --</option>
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
        </select>
    </div>
    {% endif %}

            <div style="display: inline-block;">
                <label for="group">ê·¸ë£¹ ì„ íƒ</label>
                <select name="group" id="group">
                    <option value="">-- ê·¸ë£¹ ì„ íƒ --</option>
                    {% for group in groups %}
                        <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="button">ì¡°íšŒ</button>
        </form>
</div>

<!-- Spinner Container: Initially Hidden -->
<div id="spinnerContainer" class="spinner-container" style="display: none;">
    <div class="spinner"></div>
    <p>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
</div>

<!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
{% if error_message %}
    <p style="color:red;">{{ error_message }}</p>
{% endif %}

{% if is_registered == False %}
    <p style="color:red;">ë“±ë¡ëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì •ë³´ ë“±ë¡ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš” ğŸ˜…</p>
{% endif %}

{% if user_results %}
    <h3 class="group_title">
        {% if request.user.user_type == 'S' %}
            {{selected_year}}ë…„
        {% endif %} 
        {{ selected_group }}ì˜ ë¶„ì„ í˜„í™©</h3>
    <div class="table-container">
        <!-- ë¶„ì„ í˜„í™© ì¹´ë“œ ì¶”ê°€ -->
        <div class="analysis-status-cards">
            <div class="status-card">
                <div class="card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="card-content">
                    <h4>ì „ì²´ ì¸ì›</h4>
                    <p class="card-value">{{ total_users }}ëª…</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="card-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="card-content">
                    <h4>ê²€ì‚¬ ì™„ë£Œ</h4>
                    <p class="card-value">{{ valid_count }}ëª…</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-content">
                    <h4>ê²€ì‚¬ìœ¨</h4>
                    <p class="card-value">{{ progress_percentage|floatformat:1 }}%</p>
                </div>
            </div>
        </div>
    
        <!-- Display progress -->
         <div class="progress-container">
            <div class="progress-info">
                <p class="progress_percentage" style="font-weight: 700;">ê²€ì‚¬ìœ¨: {{ progress_percentage|floatformat:1 }}%</p>
                {% comment %} <span class="progress-count">{{ valid_count }}ëª… / {{ total_users }}ëª…</span> {% endcomment %}
            </div>
            <div class="progress-bar">
                <div class="progress" style="width: {{ progress_percentage|floatformat:1 }}%;">
                    <div class="progress-glow"></div>
                </div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    {% if request.user.user_type == 'S' %}
                        <th>í•™ë…„</th>
                        <th>ë°˜</th>
                        <th>ë²ˆí˜¸</th>
                    {% else %}
                        <th>ë¶€ì„œëª…</th>
                    {% endif %}
                    <th>ì´ë¦„</th>
                    <th>ì²´í˜• ë¶„ì„ ê²°ê³¼</th>
                </tr>
            </thead>
            <tbody id="userResultsTableBody">
                {% for result in user_results %}
                <tr data-id="{{ result.user.id }}" data-valid="{{ result.analysis_valid }}">
                    {% if request.user.user_type == 'S' %}
                        <td>{{ result.user.student_grade }}</td>
                        <td>{{ result.user.student_class }}</td>
                        <td>{{ result.user.student_number }}</td>
                    {% else %}
                        <td>{{ result.user.department }}</td>
                    {% endif %}
                    <td>{{ result.user.student_name }}</td>
                    <td>
                        {% if result.analysis_valid %}
                            {% if result.created_dt %}
                            <a href="/report/{{ result.user.id }}/?selected_date={{ result.created_dt }}" class="icon-button success" aria-label="View Report">
                                    <i class="fa-solid fa-check"></i>
                                </a> 
                            {% else %}
                                <a href="{% url 'report_detail' result.user.id %}" class="icon-button success" aria-label="View Report">
                                    <i class="fa-solid fa-check"></i>
                                </a>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'no_result' %}" class="icon-button error" aria-label="No Result">
                                <i class="fa-solid fa-times"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination-container">
            <button class="pagination-button" id="prevPage">ì´ì „</button>
            <button class="pagination-button" id="nextPage">ë‹¤ìŒ</button>
        </div>
    </div>
{% endif %}



<!-- Include JavaScript for Pagination and Fetch -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const groupSelect = document.getElementById("group");
        const form = document.getElementById("dataForm");
        const spinnerContainer = document.getElementById("spinnerContainer");
        const userResultsTableBody = document.getElementById('userResultsTableBody');
        const yearGroupMap = JSON.parse('{{ year_group_map|escapejs|safe }}'); 
        const userType = '{{ request.user.user_type }}';   
        let yearSelect; 

        if (userType == 'S') {
            yearSelect = document.getElementById("year");
        }
        
        let rows = [];
        let currentPage = 1;
        const rowsPerPage = 10;
        let totalPages = 0;

        // ì—°ë„ ì„ íƒì— ë”°ë¼ ê·¸ë£¹ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateGroupOptions() {
            let groups;
            if (userType == 'S') {
                const selectedYear = yearSelect.value;
                groups = yearGroupMap[selectedYear] || [];

                groupSelect.innerHTML = '<option value="">-- ê·¸ë£¹ ì„ íƒ --</option>';
            
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupSelect.appendChild(option);
            });
            } else {
                return;
            }
            
        }
    
        /** í…Œì´ë¸”ê³¼ í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜ */
        function initializeTableAndPagination() {
            if (userResultsTableBody) {
                allRows = Array.from(userResultsTableBody.querySelectorAll('tr')); // ì „ì²´ í–‰ ì €ì¥
                rows = [...allRows]; // í˜„ì¬ í‘œì‹œí•  í–‰
                totalPages = Math.ceil(rows.length / rowsPerPage);
                currentPage = 1;
                displayTable(currentPage);
            }
        }
    

        /** ì§„í–‰ë¥  ë° HTML ë³€ìˆ˜ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
        function updateProgress(doc) {
            // ìƒë‹¨ ì„ íƒëœ ê·¸ë£¹ëª… ë³€ê²½
            const groupTitle = document.querySelector('.group_title');
            const newGroupTitle = doc.querySelector('.group_title');
            if (groupTitle && newGroupTitle) {
                groupTitle.textContent = newGroupTitle.textContent;
            }
        
            // ë¶„ì„ í˜„í™© ì¹´ë“œ ê°’ ì—…ë°ì´íŠ¸
            const statusCards = document.querySelectorAll('.card-value');
            const newStatusCards = doc.querySelectorAll('.card-value');
            if (statusCards && newStatusCards) {
                statusCards.forEach((card, index) => {
                    if (newStatusCards[index]) {
                        card.textContent = newStatusCards[index].textContent;
                    }
                });
            }
        
            // ì§„í–‰ë¥  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const progressText = document.querySelector('.progress_percentage');
            const newProgressText = doc.querySelector('.progress_percentage');
            if (progressText && newProgressText) {
                progressText.textContent = newProgressText.textContent;
            }
        
            // ì§„í–‰ë¥  ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const progressCount = document.querySelector('.progress-count');
            const newProgressCount = doc.querySelector('.progress-count');
            if (progressCount && newProgressCount) {
                progressCount.textContent = newProgressCount.textContent;
            }
        
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            const progressBar = document.querySelector('.progress-bar .progress');
            const newProgressBar = doc.querySelector('.progress-bar .progress');
            if (progressBar && newProgressBar) {
                progressBar.style.width = newProgressBar.style.width;
            }
        }
    
        function updatePaginationButtons() {
            const prevButton = document.getElementById("prevPage");
            const nextButton = document.getElementById("nextPage");
            prevButton.style.display = currentPage > 1 ? '' : 'none';
            nextButton.style.display = currentPage < totalPages ? '' : 'none';
        }
    
        function displayTable(page) {
            const startIndex = (page - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
            
            rows.forEach((row, index) => {
                row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
            });
    
            updatePaginationButtons();
        }
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById("prevPage").addEventListener("click", function() {
            if (currentPage > 1) {
                currentPage--;
                displayTable(currentPage);
            }
        });
    
        document.getElementById("nextPage").addEventListener("click", function() {
            if (currentPage < totalPages) {
                currentPage++;
                displayTable(currentPage);
            }
        });
    
        // í˜„ì¬ ì—°ë„ ì„ íƒ
        const currentYear = new Date().getFullYear().toString();
        if (userType == 'S' && !yearSelect.value) {
            yearSelect.value = currentYear;
        }
        
        // ì´ˆê¸° ê·¸ë£¹ ì˜µì…˜ ì„¤ì •
        updateGroupOptions();
        
        // ì´ì „ì— ì„ íƒëœ ê·¸ë£¹ì´ ìˆë‹¤ë©´ ì„¤ì •
        const initialSavedGroup = "{{ selected_group|default_if_none:'' }}";
        if (initialSavedGroup && groupSelect.querySelector(`option[value="${initialSavedGroup}"]`)) {
            groupSelect.value = initialSavedGroup;
        }
    
        // ì—°ë„ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (userType == 'S') {
            yearSelect.addEventListener('change', function() {
                updateGroupOptions();
                groupSelect.value = '';
            });
        }
        
        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            if (userType == 'S') {
                if (!yearSelect.value || !groupSelect.value) {
                    alert('ì—°ë„ì™€ ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            } else {
                if (!groupSelect.value) {
                    alert('ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            }
            
            spinnerContainer.style.display = 'flex';
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
            })
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // í…Œì´ë¸” ë°ì´í„° ì—…ë°ì´íŠ¸
                userResultsTableBody.innerHTML = doc.getElementById('userResultsTableBody').innerHTML;
                
                // ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ ì´ˆê¸°í™”
                sessionStorage.clear();
                
                // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                updateProgress(doc);

                // í…Œì´ë¸”ê³¼ í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™”
                initializeTableAndPagination();
                
                spinnerContainer.style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                spinnerContainer.style.display = 'none';
            });
        });
    
        // ì´ˆê¸° í…Œì´ë¸” ì„¤ì •
        initializeTableAndPagination();

    });

</script>
{% endblock %}
