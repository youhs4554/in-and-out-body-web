{% extends 'base.html' %}

{% block title %}Report{% endblock %}

{% block content %}
<h2>ê²€ì‚¬ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</h2>
<div class="form-div">
    <form id="dataForm" method="post">
        {% csrf_token %}
        {% if request.user.user_type == 'S' %}
        <div style="display: inline-block">       
                <label for="year">ì—°ë„ ì„ íƒ</label>
                <select name="year" id="year">
                    <option value="">-- ì—°ë„ ì„ íƒ --</option>
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
        </select>
    </div>
    {% endif %}

            <div style="display: inline-block;">
                <label for="group">ê·¸ë£¹ ì„ íƒ</label>
                <select name="group" id="group">
                    <option value="">-- ê·¸ë£¹ ì„ íƒ --</option>
                    {% for group in groups %}
                        <option value="{{ group }}" {% if group == selected_group %}selected{% endif %}>{{ group }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="button">ì¡°íšŒ</button>
        </form>
</div>

<!-- hr -->
 <hr style="border-width:1px 0 0 0; border-color:#fff;"/>

<!-- Spinner Container: Initially Hidden -->
<div id="spinnerContainer" class="spinner-container" style="display: none;">
    <div class="spinner"></div>
    <p>ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
</div>

<!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
{% if error_message %}
    <p style="color:red;">{{ error_message }}</p>
{% endif %}

{% if is_registered == False %}
    <p style="color:red;">ë“±ë¡ëœ ì‚¬ìš©ì ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ì ì •ë³´ ë“±ë¡ì„ ë¨¼ì € ì§„í–‰í•´ì£¼ì„¸ìš” ğŸ˜…</p>
{% endif %}

{% if user_results %}
<div style="display: flex; align-items: center; gap: 10px; margin-top:10px;">
    <h3 class="group_title" style="margin: 0;">
        {% if request.user.user_type == 'S' %}
            {{ selected_year }}ë…„
        {% endif %}
        {{ selected_group }}ì˜ ë¶„ì„ í˜„í™©
    </h3>
    <button id="report_download" style="background-color: #007bff; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 4px;">
        <a href="{% url 'report_download' %}?year={{ selected_year }}&group={{ selected_group }}" style="color: white; text-decoration: none; padding:2px 0px 2px 0px">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
    </button>
</div>
    <div class="table-container">
        <!-- ë¶„ì„ í˜„í™© ì¹´ë“œ ì¶”ê°€ -->
        <div class="analysis-status-cards">
            <div class="status-card">
                <div class="card-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="card-content">
                    <h4>ì „ì²´ ì¸ì›</h4>
                    <p class="card-value">{{ total_users }}ëª…</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="card-icon">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <div class="card-content">
                    <h4>ê²€ì‚¬ ì™„ë£Œ</h4>
                    <p class="card-value">{{ valid_count }}ëª…</p>
                </div>
            </div>
            
            <div class="status-card">
                <div class="card-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="card-content">
                    <h4>ê²€ì‚¬ìœ¨</h4>
                    <p class="card-value">{{ progress_percentage|floatformat:1 }}%</p>
                </div>
            </div>
        </div>
    
        <!-- Display progress -->
         <div class="progress-container">
            <div class="progress-info">
                <p class="progress_percentage" style="font-weight: 700;">ê²€ì‚¬ìœ¨: {{ progress_percentage|floatformat:1 }}%</p>
                {% comment %} <span class="progress-count">{{ valid_count }}ëª… / {{ total_users }}ëª…</span> {% endcomment %}
            </div>
            <div class="progress-bar">
                <div class="progress" style="width: {{ progress_percentage|floatformat:1 }}%;">
                    <div class="progress-glow"></div>
                </div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    {% if request.user.user_type == 'S' %}
                        <th>í•™ë…„</th>
                        <th>ë°˜</th>
                        <th>ë²ˆí˜¸</th>
                    {% else %}
                        <th>ë¶€ì„œëª…</th>
                    {% endif %}
                    <th>ì´ë¦„</th>
                    <th>ì²´í˜• ë¶„ì„ ê²°ê³¼</th>
                </tr>
            </thead>
            <tbody id="userResultsTableBody">
                {% for result in user_results %}
                <tr data-id="{{ result.user.id }}" data-valid="{{ result.analysis_valid }}">
                    {% if request.user.user_type == 'S' %}
                        <td>{{ result.user.student_grade }}</td>
                        <td>{{ result.user.student_class }}</td>
                        <td>{{ result.user.student_number }}</td>
                    {% else %}
                        <td>{{ result.user.department }}</td>
                    {% endif %}
                    <td>{{ result.user.student_name }}</td>
                    <td>
                        {% if result.analysis_valid %}
                            {% if result.created_dt %}
                            <a href="/report/{{ result.user.id }}/?selected_date={{ result.created_dt }}" class="icon-button success" aria-label="View Report">
                                    <i class="fa-solid fa-check"></i>
                                </a> 
                            {% else %}
                                <a href="{% url 'report_detail' result.user.id %}" class="icon-button success" aria-label="View Report">
                                    <i class="fa-solid fa-check"></i>
                                </a>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'no_result' %}" class="icon-button error" aria-label="No Result">
                                <i class="fa-solid fa-times"></i>
                            </a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if user_results|length > 10 %}
        <div class="pagination-container">
            <button class="pagination-button" id="prevPage">ì´ì „</button>
            <button class="pagination-button" id="nextPage">ë‹¤ìŒ</button>
        </div>
        {% endif %}
    </div>
{% endif %}



<!-- Include JavaScript for Pagination and Fetch -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        let groupSelect = document.getElementById("group");
        let form = document.getElementById("dataForm");
        const spinnerContainer = document.getElementById("spinnerContainer");
        let userResultsTableBody = document.getElementById('userResultsTableBody');
        let yearGroupMap = JSON.parse('{{ year_group_map|escapejs|safe }}'); 
        let userType = '{{ request.user.user_type }}';   
        let yearSelect; 

        if (userType == 'S') {
            yearSelect = document.getElementById("year");
        }
        
        let rows = [];
        let currentPage = 1;
        let rowsPerPage = 10;
        let totalPages = 0;
        let allRows = []; // ì¶”ê°€

        // ì—°ë„ ì„ íƒì— ë”°ë¼ ê·¸ë£¹ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateGroupOptions() {
            let groups;
            if (userType == 'S') {
                const selectedYear = yearSelect.value;
                groups = yearGroupMap[selectedYear] || [];

                groupSelect.innerHTML = '<option value="">-- ê·¸ë£¹ ì„ íƒ --</option>';
            
                groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    groupSelect.appendChild(option);
            });
            } else {
                return;
            }
            
        }
    
        /** í…Œì´ë¸”ê³¼ í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜ */
        function initializeTableAndPagination() {
            const userResultsTableBody = document.getElementById('userResultsTableBody');
            if (!userResultsTableBody) return;  // í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ

            allRows = Array.from(userResultsTableBody.querySelectorAll('tr')); // ì „ì²´ í–‰ ì €ì¥
            if (allRows.length === 0) return;  // í–‰ì´ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ

            rows = [...allRows]; // í˜„ì¬ í‘œì‹œí•  í–‰
            totalPages = Math.ceil(rows.length / rowsPerPage);
            currentPage = 1;
            displayTable(currentPage);
        }
    

        /** ì§„í–‰ë¥  ë° HTML ë³€ìˆ˜ë“¤ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ */
        function updateProgress(doc) {
            // ìƒë‹¨ ì„ íƒëœ ê·¸ë£¹ëª… ë³€ê²½
            const groupTitle = document.querySelector('.group_title');
            const newGroupTitle = doc.querySelector('.group_title');
            if (groupTitle && newGroupTitle) {
                groupTitle.textContent = newGroupTitle.textContent;
            }
        
            // ë¶„ì„ í˜„í™© ì¹´ë“œ ê°’ ì—…ë°ì´íŠ¸
            const statusCards = document.querySelectorAll('.card-value');
            const newStatusCards = doc.querySelectorAll('.card-value');
            if (statusCards && newStatusCards) {
                statusCards.forEach((card, index) => {
                    if (newStatusCards[index]) {
                        card.textContent = newStatusCards[index].textContent;
                    }
                });
            }
        
            // ì§„í–‰ë¥  í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const progressText = document.querySelector('.progress_percentage');
            const newProgressText = doc.querySelector('.progress_percentage');
            if (progressText && newProgressText) {
                progressText.textContent = newProgressText.textContent;
            }
        
            // ì§„í–‰ë¥  ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            const progressCount = document.querySelector('.progress-count');
            const newProgressCount = doc.querySelector('.progress-count');
            if (progressCount && newProgressCount) {
                progressCount.textContent = newProgressCount.textContent;
            }
        
            // í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
            const progressBar = document.querySelector('.progress-bar .progress');
            const newProgressBar = doc.querySelector('.progress-bar .progress');
            if (progressBar && newProgressBar) {
                progressBar.style.width = newProgressBar.style.width;
            }

            const download_btn = document.querySelector("#report_download");
            const new_download_btn = doc.querySelector("#report_download");
            if (download_btn && new_download_btn) {
                // new_download_btnìœ¼ë¡œ êµì²´
                download_btn.innerHTML = new_download_btn.innerHTML;
            }

        }
    
        function updatePaginationButtons() {
            const prevButton = document.getElementById("prevPage");
            const nextButton = document.getElementById("nextPage");
            
            // ë²„íŠ¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ
            if (!prevButton || !nextButton) return;
            
            prevButton.style.display = currentPage > 1 ? '' : 'none';
            nextButton.style.display = currentPage < totalPages ? '' : 'none';
        }
    
        function displayTable(page) {
            if (!rows || rows.length === 0) return;  // rowsê°€ ì—†ìœ¼ë©´ í•¨ìˆ˜ ì¢…ë£Œ
        
            const startIndex = (page - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
            
            rows.forEach((row, index) => {
                row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
            });
        
            // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì—…ë°ì´íŠ¸ëŠ” rowsê°€ 10ê°œ ì´ìƒì¼ ë•Œë§Œ ì‹¤í–‰
            if (rows.length > 10) {
                updatePaginationButtons();
            }
        }
        
        
        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const prevButton = document.getElementById("prevPage");
        const nextButton = document.getElementById("nextPage");
        
        if (prevButton && nextButton) {  // ë²„íŠ¼ì´ ì¡´ì¬í•  ë•Œë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            prevButton.addEventListener("click", function() {
                if (currentPage > 1) {
                    currentPage--;
                    displayTable(currentPage);
                }
            });
        
            nextButton.addEventListener("click", function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    displayTable(currentPage);
                }
            });
        }

        function attachPaginationListeners() {
            const prevButton = document.getElementById("prevPage");
            const nextButton = document.getElementById("nextPage");
            
            if (prevButton && nextButton) {
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                prevButton.replaceWith(prevButton.cloneNode(true));
                nextButton.replaceWith(nextButton.cloneNode(true));
                
                // ìƒˆë¡œìš´ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
                const newPrevButton = document.getElementById("prevPage");
                const newNextButton = document.getElementById("nextPage");
                
                // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                newPrevButton.addEventListener("click", function() {
                    if (currentPage > 1) {
                        currentPage--;
                        displayTable(currentPage);
                    }
                });
            
                newNextButton.addEventListener("click", function() {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayTable(currentPage);
                    }
                });
            }
        }
    
        // í˜„ì¬ ì—°ë„ ì„ íƒ
        const currentYear = new Date().getFullYear().toString();
        if (userType == 'S' && !yearSelect.value) {
            yearSelect.value = currentYear;
        }
        
        // ì´ˆê¸° ê·¸ë£¹ ì˜µì…˜ ì„¤ì •
        updateGroupOptions();
        
        // ì´ì „ì— ì„ íƒëœ ê·¸ë£¹ì´ ìˆë‹¤ë©´ ì„¤ì •
        const initialSavedGroup = "{{ selected_group|default_if_none:'' }}";
        if (initialSavedGroup && groupSelect.querySelector(`option[value="${initialSavedGroup}"]`)) {
            groupSelect.value = initialSavedGroup;
        }
    
        // ì—°ë„ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (userType == 'S') {
            yearSelect.addEventListener('change', function() {
                updateGroupOptions();
                groupSelect.value = '';
            });
        }
        
        // í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            if (userType == 'S') {
                if (!yearSelect.value || !groupSelect.value) {
                    alert('ì—°ë„ì™€ ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            } else {
                if (!groupSelect.value) {
                    alert('ê·¸ë£¹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            }
            
            spinnerContainer.style.display = 'flex';
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                // HTML íŒŒì‹±
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // ê¸°ì¡´ í…Œì´ë¸” ì»¨í…Œì´ë„ˆì™€ ìƒˆë¡œìš´ í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ì°¾ê¸°
                const existingContainer = document.querySelector('.table-container');
                const newContainer = doc.querySelector('.table-container');
                
                if (!newContainer) {
                    console.log('ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    if (existingContainer) {
                        existingContainer.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                    return;
                }
        
                // í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ì—…ë°ì´íŠ¸
                if (existingContainer) {
                    // ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ìˆìœ¼ë©´ ë‚´ìš©ë§Œ ì—…ë°ì´íŠ¸
                    existingContainer.innerHTML = newContainer.innerHTML;
                } else {
                    // ê¸°ì¡´ ì»¨í…Œì´ë„ˆê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
                    const parentElement = document.querySelector('#user_results') || document.querySelector('.form-div').parentNode;
                    parentElement.appendChild(newContainer.cloneNode(true));
                }
        
                // í…Œì´ë¸” ì°¸ì¡° ì—…ë°ì´íŠ¸
                userResultsTableBody = document.getElementById('userResultsTableBody');
                
                // ì§„í–‰ë¥  ì •ë³´ ì—…ë°ì´íŠ¸
                updateProgress(doc);
        
                // í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™”
                if (userResultsTableBody) {
                    const tableRows = userResultsTableBody.querySelectorAll('tr');
                    if (tableRows.length > 0) {
                        rows = Array.from(tableRows);
                        totalPages = Math.ceil(rows.length / rowsPerPage);
                        currentPage = 1;
                        displayTable(currentPage);

                        // í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
                        attachPaginationListeners();
                    }
                }
        
                // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                const downloadBtn = document.querySelector("#report_download");
                const newDownloadBtn = doc.querySelector("#report_download");
                if (downloadBtn && newDownloadBtn) {
                    downloadBtn.innerHTML = newDownloadBtn.innerHTML;
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê¸°
                spinnerContainer.style.display = 'none';
            });
        });

        // ì´ˆê¸° í…Œì´ë¸” ì„¤ì •
        initializeTableAndPagination();

    });

</script>
{% endblock %}
